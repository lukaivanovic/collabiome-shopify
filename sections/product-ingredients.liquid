{%- liquid
  if section.settings.manual_product != blank
    assign selected_product = section.settings.manual_product
    echo selected_product | json
  else
    assign selected_product = product
  endif

  assign ingredients = selected_product.metafields.custom.section_ingredients_list.value
  assign section_title = selected_product.metafields.custom.section_ingredients_title.value | default: 'Ingredients'
  assign section_description = selected_product.metafields.custom.section_ingredients_description.value | default: 'Only the best for our customers'
  assign section_eyebrow = selected_product.metafields.custom.section_ingredients_eyebrow.value | default: 'Ingredients'

  assign has_ingredients = false
  if ingredients != blank
    assign has_ingredients = true
  endif
-%}

{% if has_ingredients %}
  <div class="py-12 md:py-20 bg-product-bg-secondary">
    <div class="container-small mx-auto max-w-4xl px-4 text-center flex flex-col gap-10">
      <div>
        <p class="text-sm font-medium uppercase text-neutral-500 tracking-wider">
          {{ section_eyebrow }}
        </p>
        <h2 class="title-medium">{{ section_title }}</h2>
        {% if section_description != blank %}
          <p class="text-base opacity-70 mt-2">{{ section_description }}</p>
        {% endif %}
      </div>

      {%- liquid
        assign other_ingredients = ''
        assign other_ingredients_count = 0
      -%}

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        {% for ingredient in ingredients limit: 3 %}
          <div class="flex flex-row items-center md:flex-col gap-y-2 gap-x-4 md:items-stretch bg-white rounded-2xl overflow-hidden">
            <div class="shrink-0 w-24 h-24 md:w-full md:h-auto md:aspect-square">
              {% render 'image', image: ingredient.image, class: ' w-full h-full object-cover' %}
            </div>
            <div class="text-left md:text-center py-4">
              <h3 class="text-lg font-medium">{{ ingredient.name }}</h3>
              <p class="text-sm text-secondary">{{ ingredient.description }}</p>
            </div>
          </div>
        {% endfor %}
      </div>

      {%- liquid
        assign other_ingredients_list = ''
      -%}

      {% for ingredient in ingredients %}
        {% if forloop.index > 3 %}
          {%- liquid
            if other_ingredients_count > 0
              assign other_ingredients = other_ingredients | append: ', '
              assign other_ingredients_list = other_ingredients_list | append: '|'
            endif
            assign other_ingredients = other_ingredients | append: ingredient.name
            assign other_ingredients_list = other_ingredients_list | append: ingredient.name
            assign other_ingredients_count = other_ingredients_count | plus: 1
          -%}
        {% endif %}
      {% endfor %}

      {% if other_ingredients != '' %}
        <div>
          <div class="h-px bg-neutral-100"></div>
          <div class="text-sm uppercase tracking-wide opacity-70 mb-2 mt-6">
            {{ 'sections.product_ingredients.list' | t }}
          </div>
          <button
            type="button"
            data-drawer-trigger="ingredients-drawer"
            class="text-base font-medium text-primary hover:underline mt-2"
          >
            {{ 'sections.product_ingredients.view_all' | t }}
          </button>
        </div>
      {% endif %}
    </div>
  </div>

  {% if other_ingredients != '' %}
    <generic-drawer
      id="ingredients-drawer"
      class="fixed inset-0 z-[1000] invisible pointer-events-none transition-[visibility] duration-300 ease-in-out"
    >
      <div
        data-drawer-overlay
        class="absolute inset-0 bg-black/50 opacity-0 transition-opacity duration-300 ease-in-out"
      ></div>
      <div
        data-drawer-container
        class="absolute left-1/2 top-1/2 bg-white rounded-2xl shadow-xl flex flex-col transition-all duration-300 ease-in-out max-w-2xl w-full mx-4 max-h-[80vh]"
      >
        <div
          data-drawer-header
          class="flex items-center justify-between p-6 border-b border-neutral-200 flex-shrink-0"
        >
          <h2 data-drawer-title class="m-0 text-xl font-semibold text-gray-900">
            {{ 'sections.product_ingredients.list' | t | default: 'All Ingredients' }}
          </h2>
          <button
            data-drawer-close
            aria-label="Close drawer"
            class="flex items-center justify-center w-8 h-8 border-0 bg-transparent cursor-pointer text-gray-500 rounded transition-all duration-200 ease-in-out hover:bg-gray-100 hover:text-gray-700"
          >
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              class="w-5 h-5"
            >
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div
          data-drawer-content
          class="flex-1 overflow-y-auto p-6"
        >
          <div class="prose prose-sm max-w-none">
            {% assign ingredients_array = other_ingredients_list | split: '|' %}
            <ul class="list-none space-y-2">
              {% for ingredient_name in ingredients_array %}
                {% if ingredient_name != blank %}
                  <li class="text-base text-gray-700">{{ ingredient_name }}</li>
                {% endif %}
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    </generic-drawer>

    <script src="{{ 'drawer.js' | asset_url }}" defer="defer"></script>
  {% endif %}
{% endif %}

{% stylesheet %}
  /* Centered drawer styles */
  generic-drawer#ingredients-drawer[data-active='true'] {
    visibility: visible;
    pointer-events: auto;
  }

  generic-drawer#ingredients-drawer[data-active='true'] [data-drawer-overlay] {
    opacity: 1;
  }

  generic-drawer#ingredients-drawer [data-drawer-container] {
    transform: translate(-50%, -50%) scale(0.95);
    opacity: 0;
  }

  generic-drawer#ingredients-drawer[data-active='true'] [data-drawer-container] {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }

  /* Custom scrollbar styling */
  generic-drawer#ingredients-drawer [data-drawer-content]::-webkit-scrollbar {
    width: 0.375rem;
  }

  generic-drawer#ingredients-drawer [data-drawer-content]::-webkit-scrollbar-track {
    background-color: rgb(241 245 249);
  }

  generic-drawer#ingredients-drawer [data-drawer-content]::-webkit-scrollbar-thumb {
    background-color: rgb(203 213 225);
    border-radius: 0.125rem;
  }

  generic-drawer#ingredients-drawer [data-drawer-content]::-webkit-scrollbar-thumb:hover {
    background-color: rgb(148 163 184);
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Product Ingredients",
  "settings": [
    {
      "type": "product",
      "id": "manual_product",
      "label": "Manual product",
      "info": "Select a product to display. If no product is selected, the current page product will be used."
    }
  ],
  "tag": "section",
  "presets": [
    {
      "name": "Ingredients",
      "category": "Product"
    }
  ]
}
{% endschema %}
