{% liquid
  assign section_id = section.settings.custom_id | default: section.id
  assign selected_blog = section.settings.blog
%}

<div class="blog-grid container">
  {% if section.settings.heading != blank %}
    <div class="blog-grid__header flex items-center justify-between gap-4">
      <div>
        <h2 class="title-medium">{{ section.settings.heading | escape }}</h2>
        {% if section.settings.description != blank %}
          <p class="text-secondary pt-2">{{ section.settings.description | escape }}</p>
        {% endif %}
      </div>

      {% if selected_blog != blank and selected_blog.url != blank and section.settings.show_view_all %}
        <a
          href="{{ selected_blog.url }}"
          class="bg-white border border-black/12 rounded-full px-4 py-2 text-sm font-medium"
        >
          {{ 'sections.blog_grid.view_all' | t }}
        </a>
      {% endif %}
    </div>
  {% endif %}

  {% if selected_blog != blank and selected_blog.articles_count > 0 %}
    <div class="embla blog-grid__carousel relative pt-8" data-section-id="{{ section_id }}">
      <div class="embla__container">
        {% for article in selected_blog.articles limit: 6 %}
          <div class="embla__slide">
            {% render 'blog-article-card', article: article %}
          </div>
        {% endfor %}
      </div>

      <button
        class="embla__prev blog-grid__nav blog-grid__nav--prev -translate-x-4"
        aria-label="Prethodni članak"
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>

      <button
        class="embla__next blog-grid__nav blog-grid__nav--next translate-x-4"
        aria-label="Sljedeći članak"
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    <!-- Progress Bar -->
    <div class="blog-grid__progress" aria-hidden="true">
      <div class="blog-grid__progress-bar"></div>
    </div>
  {% endif %}
</div>

{% javascript %}
  document.addEventListener('DOMContentLoaded', function () {
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/embla-carousel/embla-carousel.umd.js';
    script.onload = function () {
      document.querySelectorAll('.blog-grid__carousel').forEach(function (carouselElement) {
        function getSlidesToScroll() {
          const width = window.innerWidth;
          if (width < 768) return 1;
          if (width <= 1024) return 2;
          return 4;
        }

        const embla = EmblaCarousel(carouselElement, {
          loop: false,
          align: 'start',
          containScroll: 'trimSnaps',
          slidesToScroll: getSlidesToScroll(),
        });

        const carouselParent = carouselElement.closest('.blog-grid');
        const prevButton = carouselElement.querySelector('.embla__prev');
        const nextButton = carouselElement.querySelector('.embla__next');
        const progressBar = carouselParent?.querySelector('.blog-grid__progress-bar');

        function updateUI() {
          if (prevButton) prevButton.disabled = !embla.canScrollPrev();
          if (nextButton) nextButton.disabled = !embla.canScrollNext();
          if (progressBar) {
            const progress = Math.min(Math.max(embla.scrollProgress() * 100, 0), 100);
            progressBar.style.width = `${progress}%`;
          }
        }

        if (prevButton) {
          prevButton.addEventListener('click', function () {
            embla.scrollPrev();
          });
        }

        if (nextButton) {
          nextButton.addEventListener('click', function () {
            embla.scrollNext();
          });
        }

        embla.on('scroll', updateUI);
        embla.on('select', updateUI);
        embla.on('reInit', updateUI);

        let currentSlidesToScroll = getSlidesToScroll();
        let resizeTimer;
        window.addEventListener(
          'resize',
          function () {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function () {
              const newSlidesToScroll = getSlidesToScroll();
              if (currentSlidesToScroll !== newSlidesToScroll) {
                currentSlidesToScroll = newSlidesToScroll;
                embla.reInit({ slidesToScroll: newSlidesToScroll });
              } else {
                embla.reInit();
              }
            }, 250);
          },
          { passive: true }
        );

        updateUI();
      });
    };
    document.head.appendChild(script);
  });
{% endjavascript %}

{% stylesheet %}
  .blog-grid__section::before {
    margin-bottom: -200px;
    padding-bottom: 240px;
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: -1;
    background: linear-gradient(
        0deg,
        hsla(0, 0%, 100%, 1) 0%,
        hsla(0, 0%, 100%, 0.7) 11%,
        hsla(0, 0%, 100%, 0.47) 22%,
        hsla(0, 0%, 100%, 0.3) 33%,
        hsla(0, 0%, 100%, 0.17) 44%,
        hsla(0, 0%, 100%, 0.09) 50%,
        hsla(0, 0%, 100%, 0.17) 56%,
        hsla(0, 0%, 100%, 0.3) 67%,
        hsla(0, 0%, 100%, 0.47) 77%,
        hsla(0, 0%, 100%, 0.7) 89%,
        hsla(0, 0%, 100%, 1) 100%
      ),
      linear-gradient(var(--gradient-recupera));
  }

  .blog-grid {
    padding-top: 120px;
    padding-bottom: 120px;
    overflow: hidden;
  }

  .blog-grid__heading {
    color: color-mix(in srgb, black 88%, transparent);
  }

  .blog-grid__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }

  .blog-grid__view-all-button {
    text-decoration: none;
    font-weight: 600;
    color: var(--color-foreground, #000);
    white-space: nowrap;
    transition: opacity 0.2s ease;
  }

  .blog-grid__view-all-button:hover {
    opacity: 0.7;
  }

  .blog-grid__carousel {
    position: relative;
  }

  .blog-grid .embla__container {
    display: flex;
    gap: 1.5rem;
  }

  .blog-grid .embla__slide {
    flex: 0 0 calc((100% - 4.5rem) / 4);
    min-width: 0;
  }

  .embla__slide .blog-card {
    width: 100%;
    height: 100%;
  }

  .blog-grid__nav {
    position: absolute;
    top: 50%;
    z-index: 2;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 50%;
    background: var(--color-neutral-200);
    border: 1px solid var(--color-neutral-300);
    color: var(--color-neutral-500);
    cursor: pointer;
    transition: all 0.2s ease;
    transform: translateY(-50%);
  }

  .blog-grid__nav--prev {
    left: 0;
  }

  .blog-grid__nav--next {
    right: 0;
  }

  .blog-grid__nav:hover:not(:disabled) {
    background: #333;
    color: #fff;
  }

  .blog-grid__nav:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .blog-grid__nav svg {
    width: 16px;
    height: 16px;
  }

  /* Progress Bar Styles */
  .blog-grid__progress {
    width: 100%;
    height: 1px;
    background-color: rgba(0, 0, 0, 0.1);
    border-radius: 1px;
    margin-top: 2rem;
    overflow: hidden;
  }

  .blog-grid__progress-bar {
    height: 100%;
    background-color: var(--color-foreground, #000);
    border-radius: 1px;
    width: 0%;
    min-width: 1px;
    transition: width 0.3s ease;
    transform-origin: left;
  }

  @media (max-width: 768px) {
    .blog-grid {
      padding-top: 80px;
      padding-bottom: 80px;
    }

    .blog-grid__header {
      flex-direction: column;
      align-items: flex-start;
    }

    .blog-grid__carousel {
      margin: 0 -16px;
      padding: 1rem 16px 0;
    }

    .blog-grid .embla__slide {
      flex: 0 0 calc(90% - 0.5625rem);
      min-width: calc(90% - 0.5625rem);
    }

    .blog-grid__nav {
      display: none;
    }

    .blog-grid__progress {
      margin-top: 1.5rem;
    }
  }

  @media (min-width: 769px) and (max-width: 1024px) {
    .blog-grid .embla__slide {
      flex: 0 0 calc((100% - 1.5rem) / 2);
    }
  }

  .blog-card {
    border-radius: var(--style-border-radius-cards, 12px);
    overflow: hidden;
  }

  .blog-card__media {
    aspect-ratio: 1 / 1;
    display: block;
    background: linear-gradient(180deg, rgb(0 0 0 / 0.04), rgb(0 0 0 / 0.12));
  }

  .blog-card__media img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .blog-card__content {
    padding: 1rem;
    display: grid;
    gap: 0.25rem;
  }

  .blog-card__title a {
    color: inherit;
    text-decoration: none;
  }

  .blog-card__meta {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .blog-card__excerpt {
    margin: 0;
    opacity: 0.9;
  }

  .blog-card__link {
    width: fit-content;
    text-decoration: none;
    color: var(--color-foreground);
    font-weight: 600;
  }

  .blog-grid__footer {
    margin-top: 1rem;
    text-align: center;
  }
  .blog-grid__view-all {
    text-decoration: none;
    font-weight: 600;
  }
  .blog-grid__empty {
    opacity: 0.7;
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Blog grid",
  "tag": "section",
  "class": "blog-grid__section",
  "settings": [
    { "type": "header", "content": "Content" },
    { "type": "text", "id": "heading", "label": "Text", "default": "Najnoviji članci" },
    { "type": "textarea", "id": "description", "label": "Description", "default": "Opišite ovu kategoriju" },
    { "type": "blog", "id": "blog", "label": "Blog" },
    { "type": "checkbox", "id": "show_date", "label": "Show date", "default": true },
    { "type": "checkbox", "id": "show_author", "label": "Show author", "default": false },
    { "type": "checkbox", "id": "show_excerpt", "label": "Show excerpt", "default": true },
    {
      "type": "range",
      "id": "excerpt_words",
      "label": "Excerpt length",
      "min": 5,
      "max": 60,
      "step": 1,
      "default": 20
    },
    { "type": "checkbox", "id": "show_view_all", "label": "Show view all", "default": true }
  ],
  "presets": [{ "name": "Blog grid", "category": "Main" }]
}
{% endschema %}
