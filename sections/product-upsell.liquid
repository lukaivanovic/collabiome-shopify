{%- liquid
  assign upsell_metafield = product.metafields.custom.upsell_products.value

  assign section_title = product.metafields.custom.section_upsell_title.value | default: 'Complete your routine'
  assign section_description = product.metafields.custom.section_upsell_description.value

  assign has_upsell = false
  if upsell_metafield != blank
    assign has_upsell = true
  endif
-%}

{% if has_upsell %}
  <div class="py-16 md:py-30 bg-product-bg-secondary">
    <div class="container mx-auto px-4">
      <div class="mx-auto max-w-2xl text-center">
        <h2 class="title-medium">{{ section_title }}</h2>

        {% if section_description != blank %}
          <p class="mt-3 text-base text-gray-600">{{ section_description }}</p>
        {% endif %}
      </div>

      <div class="mt-12 hidden gap-8 md:grid md:grid-cols-2 lg:grid-cols-3 md:items-stretch">
        {% for upsell_item in upsell_metafield %}
          {% render 'product-upsell-card',
            product: upsell_item.product.value,
            title: upsell_item.title,
            description: upsell_item.description,
            image: upsell_item.image,
            step_index: forloop.index
          %}
        {% endfor %}
      </div>

      <div class="mt-12 md:hidden">
        <div class="embla embla-upsell overflow-hidden" data-section-id="{{ section.id }}">
          <div class="embla__container flex">
            {% for upsell_item in upsell_metafield %}
              <div class="embla__slide w-full flex-shrink-0 px-2">
                {% render 'product-upsell-card',
                  product: upsell_item.product.value,
                  title: upsell_item.title,
                  description: upsell_item.description,
                  image: upsell_item.image,
                  step_index: forloop.index
                %}
              </div>
            {% endfor %}
          </div>
        </div>

        {% if upsell_metafield.size > 1 %}
          <div class="mt-6 flex justify-center gap-2">
            {% for upsell_product in upsell_metafield %}
              <button
                class="embla__dot h-2 w-2 rounded-full bg-gray-300 transition-all"
                data-slide="{{ forloop.index0 }}"
                aria-label="{{ 'sections.product_upsell.dot_aria_label' | t: slide: forloop.index }}"
              ></button>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
{% endif %}

{% stylesheet %}
  .embla-upsell {
    position: relative;
  }

  .embla-upsell .embla__container {
    display: flex;
  }

  .embla-upsell .embla__slide {
    flex: 0 0 100%;
    min-width: 0;
  }

  .embla__dot {
    cursor: pointer;
  }

  .embla__dot.active {
    background-color: #4b5563;
  }
{% endstylesheet %}

{% javascript %}
  document.addEventListener('DOMContentLoaded', function () {
    const MOBILE_MEDIA_QUERY = '(max-width: 767px)';
    const SCRIPT_SELECTOR = 'script[data-embla-carousel]';

    const mobileMediaQuery = window.matchMedia(MOBILE_MEDIA_QUERY);

    const getCarouselDots = (carouselElement) => {
      const parent = carouselElement.parentElement;
      if (!parent) {
        return [];
      }

      return Array.from(parent.querySelectorAll('.embla__dot'));
    };

    const bindDotHandlers = (carouselElement, embla, dots) => {
      dots.forEach((dot, index) => {
        const handler = () => {
          embla.scrollTo(index);
        };

        const handlers = dot.__emblaHandlers || [];
        handlers.push({ carousel: carouselElement, handler });
        dot.__emblaHandlers = handlers;

        dot.addEventListener('click', handler);
      });
    };

    const unbindDotHandlers = (carouselElement, dots) => {
      dots.forEach((dot) => {
        if (!dot.__emblaHandlers) {
          return;
        }

        dot.__emblaHandlers = dot.__emblaHandlers.filter((binding) => {
          if (binding.carousel === carouselElement) {
            dot.removeEventListener('click', binding.handler);
            return false;
          }

          return true;
        });

        if (!dot.__emblaHandlers.length) {
          delete dot.__emblaHandlers;
        }
      });
    };

    const updateDotState = (dots, embla) => {
      const selectedIndex = embla.selectedScrollSnap();

      dots.forEach((dot, index) => {
        const isActive = index === selectedIndex;
        dot.classList.toggle('active', isActive);
        dot.classList.toggle('bg-gray-600', isActive);
        dot.classList.toggle('bg-gray-300', !isActive);
        dot.setAttribute('aria-current', isActive ? 'true' : 'false');
      });
    };

    const initializeCarousel = (carouselElement) => {
      if (carouselElement.dataset.emblaInitialized === 'true') {
        return;
      }

      const dots = getCarouselDots(carouselElement);
      const embla = EmblaCarousel(carouselElement, {
        align: 'start',
        loop: false,
        containScroll: 'trimSnaps',
      });

      carouselElement.__embla = embla;
      carouselElement.dataset.emblaInitialized = 'true';

      bindDotHandlers(carouselElement, embla, dots);
      updateDotState(dots, embla);

      embla.on('select', () => {
        updateDotState(dots, embla);
      });
    };

    const destroyCarousel = (carouselElement) => {
      if (!carouselElement.__embla) {
        return;
      }

      const dots = getCarouselDots(carouselElement);
      unbindDotHandlers(carouselElement, dots);

      carouselElement.__embla.destroy();
      delete carouselElement.__embla;
      carouselElement.dataset.emblaInitialized = '';

      dots.forEach((dot) => {
        dot.classList.remove('active', 'bg-gray-600');
        dot.classList.add('bg-gray-300');
        dot.removeAttribute('aria-current');
      });
    };

    const initializeAllCarousels = () => {
      if (!window.EmblaCarousel || !mobileMediaQuery.matches) {
        return;
      }

      document.querySelectorAll('.embla-upsell').forEach((carouselElement) => {
        if (carouselElement.offsetParent === null) {
          return;
        }

        initializeCarousel(carouselElement);
      });
    };

    const destroyAllCarousels = () => {
      document.querySelectorAll('.embla-upsell').forEach(destroyCarousel);
    };

    const loadEmblaAndInit = () => {
      if (!document.querySelector('.embla-upsell')) {
        return;
      }

      if (window.EmblaCarousel) {
        initializeAllCarousels();
        return;
      }

      const existingScript = document.querySelector(SCRIPT_SELECTOR);
      if (existingScript) {
        existingScript.addEventListener('load', initializeAllCarousels, { once: true });
        return;
      }

      const script = document.createElement('script');
      script.src = 'https://unpkg.com/embla-carousel/embla-carousel.umd.js';
      script.async = true;
      script.dataset.emblaCarousel = 'true';
      script.addEventListener('load', initializeAllCarousels, { once: true });
      document.head.appendChild(script);
    };

    loadEmblaAndInit();

    const handleViewportChange = (event) => {
      if (event.matches) {
        loadEmblaAndInit();
      } else {
        destroyAllCarousels();
      }
    };

    if (mobileMediaQuery.addEventListener) {
      mobileMediaQuery.addEventListener('change', handleViewportChange);
    } else if (mobileMediaQuery.addListener) {
      mobileMediaQuery.addListener(handleViewportChange);
    }

    document.addEventListener('shopify:section:load', loadEmblaAndInit);
    document.addEventListener('shopify:section:unload', (event) => {
      event.target.querySelectorAll('.embla-upsell').forEach(destroyCarousel);
    });
  });
{% endjavascript %}

{% schema %}
{
  "name": "Product Upsell",
  "tag": "section",
  "presets": [
    {
      "name": "Product Upsell",
      "category": "Product"
    }
  ]
}
{% endschema %}
