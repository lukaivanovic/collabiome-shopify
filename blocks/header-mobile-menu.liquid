{% doc %}
  Mobile Navigation Menu

  Renders a full-screen mobile menu drawer with overlay.

  @param {object} shop_menu - Shop navigation menu (required)
  @param {object} marketing_menu - Marketing/utility menu (optional)

  @example
  {% render 'header-mobile-menu',
    shop_menu: section.settings.shop_menu,
    marketing_menu: section.settings.marketing_menu
  %}
{% enddoc %}

{% liquid
  assign shop_menu = shop_menu | default: empty
  assign marketing_menu = marketing_menu | default: empty

  # Quiz banner visibility
  assign quiz_banner_has_content = false
  if block.settings.quiz_banner_title != blank
    assign quiz_banner_has_content = true
  elsif block.settings.quiz_banner_description != blank
    assign quiz_banner_has_content = true
  endif
%}

<!-- Mobile Header Bar -->
<nav class="bg-[var(--color-background-default)] border-b border-black/12 h-16 grid grid-cols-[1fr_auto_1fr] items-center justify-center px-4">
  <div class="flex items-center justify-start">
    <button
      class="flex items-center justify-center p-2 rounded hover:bg-black/5 focus:outline-2 focus:outline-[var(--color-foreground)] focus:outline-offset-2"
      aria-label="Open navigation menu"
      aria-expanded="false"
      data-menu-toggle
    >
      {{ 'icon-menu.svg' | inline_asset_content }}
    </button>
  </div>

  <a href="{{ routes.root_url }}" aria-label="{{ shop.name | escape }}" class="[&>svg]:size-12">
    {{ 'logo-mark.svg' | inline_asset_content }}
  </a>

  <div class="flex items-center gap-2 justify-end">
    {% render 'header-customer-avatar' %}
    <a
      href="{{ routes.cart_url }}"
      aria-label="Cart"
      aria-haspopup="drawer"
      id="cart-icon-bubble"
      class="flex items-center justify-center size-6 [&>svg]:size-6"
    >
      {{ 'icon-cart.svg' | inline_asset_content }}
    </a>
  </div>

  <!-- Mobile Menu Drawer -->
</nav>

<div
  id="mobile-menu"
  class="absolute left-0 right-0 top-16 z-[9999] h-[calc(100dvh-4rem)] overflow-y-scroll w-screen opacity-0 invisible transition-opacity duration-300 aria-[hidden=false]:opacity-100 aria-[hidden=false]:visible"
  aria-hidden="true"
  data-mobile-menu
>
  <!-- Menu Content -->
  <nav class="w-full bg-[var(--color-background-default)] flex flex-col transform -translate-x-full aria-[hidden=false]:translate-x-0 shadow-lg p-4 gap-8">
    {% comment %}
      Quiz banner for customers who don't know what to choose.
      Fully optional â€“ shown only when at least title or description is filled.
    {% endcomment %}
    {% if quiz_banner_has_content %}
      {% assign quiz_banner_link = block.settings.quiz_banner_link %}

      <a href="{{ quiz_banner_link }}" class="relative block overflow-hidden bg-black text-white rounded-md">
        <div class="absolute inset-0 z-0 overflow-hidden" aria-hidden="true">
          {% if block.settings.quiz_banner_image != blank %}
            {{
              block.settings.quiz_banner_image
              | image_url: width: 800
              | image_tag:
                loading: 'lazy',
                sizes: '100vw',
                alt: block.settings.quiz_banner_title,
                class: 'absolute inset-0 w-full h-full object-cover'
            }}
          {% else %}
            <div class="w-full h-full bg-gradient-to-r from-black/60 to-black/30"></div>
          {% endif %}
          <div
            class="absolute inset-0 pointer-events-none"
            style="background: {{ block.settings.quiz_banner_overlay_color | default: '#000000' }}; opacity: {{ block.settings.quiz_banner_overlay_opacity | default: 30 | divided_by: 100.0 }};"
          ></div>
        </div>

        <div class="relative z-10 flex justify-between gap-3">
          <div class="space-y-2">
            <h2 class="text-lg font-semibold leading-snug">
              {{ block.settings.quiz_banner_title | escape }}
            </h2>
            <p class="text-sm text-white/80">
              {{ block.settings.quiz_banner_description }}
            </p>
          </div>
          <div class="flex items-center">
            <span class="inline-flex items-center gap-2 text-sm font-medium underline-offset-4 hover:underline">
              {{ block.settings.quiz_banner_link_text | default: 'Take quiz' | escape }}
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 16 16"
                aria-hidden="true"
                class="w-4 h-4"
              >
                <path
                  d="M5.5 3.5L10.5 8L5.5 12.5"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </span>
          </div>
        </div>
      </a>
    {% endif %}

    {% comment %} Render category links blocks {% endcomment %}
    {% content_for 'blocks' %}

    {% if shop_menu and shop_menu.links.size > 0 %}
      <div class="mb-6">
        <ul class="list-none m-0 p-0">
          {% for link in shop_menu.links %}
            <li class="border-b border-black/5">
              <a
                href="{{ link.url }}"
                class="block py-4 text-[var(--color-foreground)] no-underline text-lg font-medium hover:bg-black/5 focus:outline-2 focus:outline-[var(--color-foreground)] focus:outline-offset-[-2px]"
              >
                {{ link.title }}
              </a>
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% if marketing_menu and marketing_menu.links.size > 0 %}
      <div>
        <ul class="list-none m-0 p-0 flex flex-col gap-2">
          {% for link in marketing_menu.links %}
            <li>
              <a
                href="{{ link.url }}"
                class="block py-2 text-[var(--color-foreground)]/64 no-underline text-base hover:text-[var(--color-foreground)] focus:outline-2 focus:outline-[var(--color-foreground)] focus:outline-offset-2"
              >
                {{ link.title }}
              </a>
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  </nav>
</div>

{% javascript %}
  class MobileMenu {
    constructor() {
      this.menuToggle = document.querySelector('[data-menu-toggle]');
      this.mobileMenu = document.querySelector('[data-mobile-menu]');
      this.menuContent = this.mobileMenu?.querySelector('.transform');
      this.menuOverlay = document.querySelector('[data-menu-overlay]');
      this.isOpen = false;

      this.init();
    }

    init() {
      if (!this.menuToggle || !this.mobileMenu) {
        console.error('MobileMenu: Required elements not found');
        return;
      }

      this.bindEvents();
      this.setupFocusManagement();
    }

    bindEvents() {
      this.menuToggle.addEventListener('click', () => this.toggle());
      this.menuOverlay.addEventListener('click', () => this.close());

      // Close on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && this.isOpen) {
          this.close();
        }
      });

      // Close on window resize to desktop
      window.addEventListener('resize', () => {
        if (window.innerWidth >= 768 && this.isOpen) {
          this.close();
        }
      });

      // Close menu when clicking a link
      this.mobileMenu.addEventListener('click', (e) => {
        if (e.target.matches('a[href]')) {
          this.close();
        }
      });
    }

    setupFocusManagement() {
      // Trap focus within mobile menu when open
      this.mobileMenu.addEventListener('keydown', (e) => {
        if (!this.isOpen) return;

        const focusableElements = this.mobileMenu.querySelectorAll(
          '[href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];

        if (e.key === 'Tab') {
          if (e.shiftKey) {
            if (document.activeElement === firstElement) {
              e.preventDefault();
              lastElement.focus();
            }
          } else {
            if (document.activeElement === lastElement) {
              e.preventDefault();
              firstElement.focus();
            }
          }
        }
      });
    }

    toggle() {
      this.isOpen ? this.close() : this.open();
    }

    open() {
      this.isOpen = true;
      this.menuToggle.setAttribute('aria-expanded', 'true');
      this.mobileMenu.setAttribute('aria-hidden', 'false');
      if (this.menuContent) {
        this.menuContent.setAttribute('aria-hidden', 'false');
      }
      document.body.style.overflow = 'hidden';
    }

    close() {
      this.isOpen = false;
      this.menuToggle.setAttribute('aria-expanded', 'false');
      this.mobileMenu.setAttribute('aria-hidden', 'true');
      if (this.menuContent) {
        this.menuContent.setAttribute('aria-hidden', 'true');
      }
      document.body.style.overflow = '';
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => new MobileMenu());
  } else {
    new MobileMenu();
  }
{% endjavascript %}

{% schema %}
{
  "name": "Mobile menu",
  "blocks": [
    {
      "type": "mobile-menu-category-links"
    }
  ],
  "settings": [
    {
      "type": "link_list",
      "id": "shop_menu",
      "label": "Shop menu"
    },
    {
      "type": "header",
      "content": "Quiz banner"
    },
    {
      "type": "text",
      "id": "quiz_banner_title",
      "label": "Quiz banner title"
    },
    {
      "type": "richtext",
      "id": "quiz_banner_description",
      "label": "Quiz banner description"
    },
    {
      "type": "image_picker",
      "id": "quiz_banner_image",
      "label": "Quiz banner image"
    },
    {
      "type": "color",
      "id": "quiz_banner_overlay_color",
      "label": "Quiz banner overlay color",
      "default": "#000000",
      "alpha": true
    },
    {
      "type": "range",
      "id": "quiz_banner_overlay_opacity",
      "label": "Quiz banner overlay opacity",
      "min": 0,
      "max": 100,
      "step": 1,
      "default": 30,
      "unit": "%"
    },
    {
      "type": "url",
      "id": "quiz_banner_link",
      "label": "Quiz banner link"
    },
    {
      "type": "text",
      "id": "quiz_banner_link_text",
      "label": "Quiz banner link text",
      "default": "Take quiz"
    }
  ],
  "presets": [
    {
      "name": "Mobile menu",
      "blocks": [
        {
          "type": "mobile-menu-category-links"
        }
      ]
    }
  ]
}
{% endschema %}
