{% doc %}
  Mobile Navigation Menu

  Renders a full-screen mobile menu drawer with overlay.

  @param {object} shop_menu - Shop navigation menu (required)
  @param {object} marketing_menu - Marketing/utility menu (optional)

  @example
  {% render 'header-mobile-menu',
    shop_menu: section.settings.shop_menu,
    marketing_menu: section.settings.marketing_menu
  %}
{% enddoc %}

{% liquid
  assign shop_menu = shop_menu | default: empty
  assign marketing_menu = marketing_menu | default: empty
%}

<!-- Mobile Header Bar -->
<nav class="bg-[var(--color-background-default)] border-b border-black/12 h-16 grid grid-cols-[1fr_auto_1fr] items-center justify-center px-4">
  <div class="flex items-center justify-start">
    <button
      class="flex items-center justify-center p-2 rounded hover:bg-black/5 focus:outline-2 focus:outline-[var(--color-foreground)] focus:outline-offset-2"
      aria-label="Open navigation menu"
      aria-expanded="false"
      data-menu-toggle
    >
      {{ 'icon-menu.svg' | inline_asset_content }}
    </button>
  </div>

  <a href="{{ routes.root_url }}" aria-label="{{ shop.name | escape }}" class="[&>svg]:size-12">
    {{ 'logo-mark.svg' | inline_asset_content }}
  </a>

  <div class="flex items-center gap-2 justify-end">
    {% render 'header-customer-avatar' %}
    <a
      href="{{ routes.cart_url }}"
      aria-label="Cart"
      aria-haspopup="drawer"
      id="cart-icon-bubble"
      class="relative flex items-center justify-center size-6 [&>svg]:size-6"
    >
      {{ 'icon-cart.svg' | inline_asset_content }}
      {% if cart.item_count > 0 %}
        <span
          class="cart-count-badge absolute -top-1 -right-1 flex items-center justify-center min-w-[18px] h-[18px] px-1.5 text-xs font-medium text-[var(--product-accent-foreground)] bg-[var(--product-accent)] rounded-full"
          aria-label="{{ cart.item_count }} items in cart"
        >
          {{ cart.item_count }}
        </span>
      {% endif %}
    </a>
  </div>

  <!-- Mobile Menu Drawer -->
</nav>

<div
  id="mobile-menu"
  class="absolute left-0 right-0 top-16 z-[9999] h-[calc(100dvh-4rem)] bg-background-default w-screen opacity-0 invisible transition-opacity duration-300 aria-[hidden=false]:opacity-100 aria-[hidden=false]:visible"
  aria-hidden="true"
  data-mobile-menu
>
  <!-- Menu Content -->
  <nav class="w-full overflow-y-scroll overscroll-contain transform -translate-x-full aria-[hidden=false]:translate-x-0 pt-4 px-4 pb-16 space-y-8 h-full">
    {% comment %} Render category links blocks {% endcomment %}
    {% content_for 'blocks' %}

    {% comment %}
      Quiz banner for customers who don't know what to choose.
      Uses global settings from Theme Settings > Quiz Banner.
    {% endcomment %}
    {% render 'quiz-banner', variant: 'mobile' %}

    {% if marketing_menu and marketing_menu.links.size > 0 %}
      <div>
        <ul class="list-none m-0 p-0 flex flex-col gap-2">
          {% for link in marketing_menu.links %}
            <li>
              <a
                href="{{ link.url }}"
                class="block py-2 text-[var(--color-foreground)]/64 no-underline text-base hover:text-[var(--color-foreground)] focus:outline-2 focus:outline-[var(--color-foreground)] focus:outline-offset-2"
              >
                {{ link.title }}
              </a>
            </li>
          {% endfor %}
          <li>
            <a
              href="{{ link.url }}"
              class="block py-2 text-[var(--color-foreground)]/64 no-underline text-base hover:text-[var(--color-foreground)] focus:outline-2 focus:outline-[var(--color-foreground)] focus:outline-offset-2"
            >
              Moj profil
            </a>
          </li>
        </ul>
      </div>
    {% endif %}
  </nav>
</div>

{% javascript %}
  class MobileMenu {
    constructor() {
      this.menuToggle = document.querySelector('[data-menu-toggle]');
      this.mobileMenu = document.querySelector('[data-mobile-menu]');
      this.menuContent = this.mobileMenu?.querySelector('.transform');
      this.menuOverlay = document.querySelector('[data-menu-overlay]');
      this.isOpen = false;

      this.init();
    }

    init() {
      if (!this.menuToggle || !this.mobileMenu) {
        console.error('MobileMenu: Required elements not found');
        return;
      }

      this.bindEvents();
      this.setupFocusManagement();
    }

    bindEvents() {
      this.menuToggle.addEventListener('click', () => this.toggle());
      this.menuOverlay.addEventListener('click', () => this.close());

      // Close on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && this.isOpen) {
          this.close();
        }
      });

      // Close on window resize to desktop
      window.addEventListener('resize', () => {
        if (window.innerWidth >= 768 && this.isOpen) {
          this.close();
        }
      });

      // Close menu when clicking a link
      this.mobileMenu.addEventListener('click', (e) => {
        if (e.target.matches('a[href]')) {
          this.close();
        }
      });
    }

    setupFocusManagement() {
      // Trap focus within mobile menu when open
      this.mobileMenu.addEventListener('keydown', (e) => {
        if (!this.isOpen) return;

        const focusableElements = this.mobileMenu.querySelectorAll(
          '[href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];

        if (e.key === 'Tab') {
          if (e.shiftKey) {
            if (document.activeElement === firstElement) {
              e.preventDefault();
              lastElement.focus();
            }
          } else {
            if (document.activeElement === lastElement) {
              e.preventDefault();
              firstElement.focus();
            }
          }
        }
      });
    }

    toggle() {
      this.isOpen ? this.close() : this.open();
    }

    open() {
      this.isOpen = true;
      this.menuToggle.setAttribute('aria-expanded', 'true');
      this.mobileMenu.setAttribute('aria-hidden', 'false');
      if (this.menuContent) {
        this.menuContent.setAttribute('aria-hidden', 'false');
      }
      document.body.style.overflow = 'hidden';
    }

    close() {
      this.isOpen = false;
      this.menuToggle.setAttribute('aria-expanded', 'false');
      this.mobileMenu.setAttribute('aria-hidden', 'true');
      if (this.menuContent) {
        this.menuContent.setAttribute('aria-hidden', 'true');
      }
      document.body.style.overflow = '';
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => new MobileMenu());
  } else {
    new MobileMenu();
  }
{% endjavascript %}

{% schema %}
{
  "name": "Mobile menu",
  "blocks": [
    {
      "type": "mobile-menu-category-links"
    }
  ],
  "settings": [
    {
      "type": "link_list",
      "id": "shop_menu",
      "label": "Shop menu"
    }
  ],
  "presets": [
    {
      "name": "Mobile menu",
      "blocks": [
        {
          "type": "mobile-menu-category-links"
        }
      ]
    }
  ]
}
{% endschema %}
