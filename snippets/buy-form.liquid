{% doc %}
  Renders a message.

  @param {string} product - Product object.
  @param {string} button_variant - Button variant.
  @param {object} section - Section object.
  @param {string} product_form_id - Product form id.
  @param {boolean} gift_card_recipient_feature_active - Gift card recipient feature active.
  @param {boolean} quantity_rule_soldout - Quantity rule sold out.
  @param {boolean} show_dynamic_checkout - Show dynamic checkout.
  @param {string} section_id - Section id.

  @example
  {% render 'buy-form', product: product %}
{% enddoc %}

{% comment %}
  {% doc %}
    Buy Form Component

    Renders a product buy form with variant options and a submit button.

    @param {object} product - Product object (required)

    @example
    {% render 'buy-form', product: product %}
  {% enddoc %}
{% endcomment %}

{% liquid
  assign button_variant = button_variant | default: 'default'

  assign button_classes = 'product-form__submit button button--full-width w-full rounded-full'

  if button_variant == 'neutral_large'
    assign button_classes = button_classes | append: ' button-neutral text-white'
  else
    assign button_classes = button_classes | append: ' button-boost text-blue'
  endif
%}

<product-form
  class="product-form"
  data-hide-errors="{{ gift_card_recipient_feature_active }}"
  data-section-id="{{ section.id }}"
  data-product-id="{{ product.id }}"
>
  <div class="product-form__error-message-wrapper" role="alert" hidden>
    <span class="svg-wrapper">
      {{- 'icon-error.svg' | inline_asset_content -}}
    </span>
    <span class="product-form__error-message"></span>
  </div>

  {%- liquid
    assign first_variant = product.first_available_variant
    assign selected_variant = product.selected_or_first_available_variant
  -%}

  {%- form 'product',
    product,
    id: product_form_id,
    class: 'form',
    novalidate: 'novalidate',
    data-type: 'add-to-cart-form'
  -%}
    <input
      type="hidden"
      name="id"
      value="{% if selected_variant != blank %}{{ selected_variant.id }}{% endif %}"
      {% if selected_variant == blank or selected_variant.available == false or quantity_rule_soldout %}
        disabled
      {% endif %}
      class="product-variant-id"
    >
    <div class="flex flex-col gap-4">
      {% unless product.has_only_default_variant %}
        {% comment %}  Variants {% endcomment %}
        <div class="flex flex-row gap-2 h-8">
          {% for option in product.options_with_values %}
            {% comment %}  Options {% endcomment %}
            <div class="flex flex-row gap-2">
              {% for value in option.values %}
                <label
                  for="options[{{ option.name }}]-{{ forloop.index }}"
                  class="variant-option relative flex items-center px-2 py-1 gap-2 border bg-white rounded-md cursor-pointer transition-all border-neutral-200 hover:bg-neutral-100 text-neutral-700 data-[selected=true]:text-black data-[selected=true]:border-[var(--product-accent)] data-[selected=true]:bg-primary/5"
                  data-option-label
                  {% if option.selected_value == value %}
                    data-selected="true"
                  {% else %}
                    data-selected="false"
                  {% endif %}
                >
                  <input
                    type="radio"
                    id="options[{{ option.name }}]-{{ forloop.index }}"
                    name="options[{{ option.name }}]"
                    value="{{ value }}"
                    {% if option.selected_value == value %}
                      checked
                    {% endif %}
                    class="sr-only"
                  >
                  <span class="font-medium text-sm">{{ value }}</span>
                  <span
                    class="hidden text-xxs font-medium px-1.5 py-0.5 tabular-nums rounded-full bg-[var(--product-accent)] text-[var(--product-button-text-color)] whitespace-nowrap"
                    data-variant-badge
                  ></span>
                </label>
              {% endfor %}
            </div>
          {% endfor %}
        </div>
        {%- liquid
          assign free_delivery_threshold = 5000
          assign current_price = 0
          if selected_variant != blank
            assign current_price = selected_variant.price
          endif
          assign show_free_delivery = false
          if current_price >= free_delivery_threshold
            assign show_free_delivery = true
          endif
        -%}
        <div
          class="free-delivery-label text-xs font-medium text-green-600 {% unless show_free_delivery %}hidden{% endunless %}"
          data-free-delivery-label
        >
          Besplatna dostava
        </div>
      {% endunless %}

      <div class="product-form__buttons">
        {%- liquid
          assign quantity_rule_soldout = false
          if selected_variant != blank
            assign check_against_inventory = true
            if selected_variant.inventory_management != 'shopify' or selected_variant.inventory_policy == 'continue'
              assign check_against_inventory = false
            endif
            if selected_variant.quantity_rule.min > selected_variant.inventory_quantity and check_against_inventory
              assign quantity_rule_soldout = true
            endif
          endif
        -%}
        <button
          id="ProductSubmitButton-{{ section_id | default: 'main' }}"
          type="submit"
          name="add"
          class="button flex items-center gap-2 h-12 px-7 text-base [background:var(--product-button-background)] [color:var(--product-button-text-color)] w-full"
          {% if selected_variant == blank or selected_variant.available == false or quantity_rule_soldout %}
            disabled
          {% endif %}
        >
          <div class="size-6">
            {{ 'icon-cart.svg' | inline_asset_content }}
          </div>
          <span>
            {%- if selected_variant == blank -%}
              Unavailable
            {%- elsif selected_variant.available == false or quantity_rule_soldout -%}
              Sold out
            {%- else -%}
              Add to cart ({{ selected_variant.price | money }})
            {%- endif -%}
          </span>
          {% comment %} {%- render 'loading-spinner' -%} {% endcomment %}
        </button>
        {%- if show_dynamic_checkout -%}
          {{ form | payment_button }}
        {%- endif -%}
      </div>
    </div>
  {%- endform -%}
</product-form>

{% stylesheet %}
  .variant-savings-badge {
    font-size: 0.625rem; /* text-xs */
    font-weight: 500; /* font-medium */
    padding: 0.125rem 0.375rem; /* px-1.5 py-0.5 */
    border-radius: 9999px; /* rounded-full */
    white-space: nowrap;
    line-height: 1.2;
  }

  .variant-option {
    position: relative;
  }
{% endstylesheet %}

{% javascript %}
  // Prevent clicks on variant options and buttons from propagating to parent link
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('product-form').forEach(function (productForm) {
      // Stop propagation for clicks on variant options and form buttons
      const interactiveElements = productForm.querySelectorAll(
        '[data-option-label], .product-form__submit, input[type="radio"], button[type="submit"]'
      );

      interactiveElements.forEach(function (element) {
        // Handle both click and touch events for mobile compatibility
        function handleInteraction(e) {
          // Stop propagation to prevent navigation when clicking on form controls
          e.stopPropagation();
          // Prevent default only if it's a link
          if (e.target.closest('a')) {
            e.preventDefault();
          }
        }

        element.addEventListener('click', handleInteraction);
        element.addEventListener('touchend', function (e) {
          handleInteraction(e);
          // Trigger click for accessibility and form submission
          if (!e.defaultPrevented) {
            const clickEvent = new MouseEvent('click', {
              bubbles: true,
              cancelable: true,
              view: window,
            });
            element.dispatchEvent(clickEvent);
          }
        });
      });

      // Update free delivery label when variant changes
      const freeDeliveryLabel = productForm.querySelector('[data-free-delivery-label]');
      if (freeDeliveryLabel && typeof subscribe !== 'undefined' && typeof PUB_SUB_EVENTS !== 'undefined') {
        const updateFreeDeliveryLabel = function (variant) {
          if (variant && variant.price >= 5000) {
            freeDeliveryLabel.classList.remove('hidden');
          } else {
            freeDeliveryLabel.classList.add('hidden');
          }
        };

        // Listen to variant change events via pub/sub
        subscribe(PUB_SUB_EVENTS.variantChange, function (data) {
          if (data && data.variant) {
            updateFreeDeliveryLabel(data.variant);
          }
        });

        // Initial check
        const variantIdInput = productForm.querySelector('.product-variant-id');
        if (variantIdInput && variantIdInput.value) {
          const productId = productForm.dataset.productId;
          const productDataScript = document.querySelector(productId ? `#product-data-${productId}` : '#product-data');
          if (productDataScript) {
            const product = JSON.parse(productDataScript.textContent);
            const variant = product.variants.find((v) => v.id == variantIdInput.value);
            if (variant) {
              updateFreeDeliveryLabel(variant);
            }
          }
        }
      }
    });
  });
{% endjavascript %}
