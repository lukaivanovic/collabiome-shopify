{% doc %}
  Product Card Mini

  Renders a compact horizontal product card with the image on the left and
  textual details plus a simplified buy form on the right.

  @param {product} product - Product object to render (required)
  @param {boolean} hide_buy_form - Hide the mini buy form (default: false)
  @param {boolean} show_dynamic_checkout - Display accelerated checkout button (default: true)
  @param {string} card_class - Additional utility classes for the wrapper
{% enddoc %}

{% liquid
  assign product = product | default: empty
  assign hide_buy_form = hide_buy_form | default: false
  if show_dynamic_checkout == blank
    assign show_dynamic_checkout = true
  endif
  assign card_class = card_class | default: ''
  assign passed_headline_text = headline_text | default: ''
  assign headline_text = ''

  if product != empty
    assign headline_metafield = product.metafields.custom.headline
    if headline_metafield and headline_metafield != blank
      assign headline_text = headline_metafield | metafield_text | strip_html
    endif
  endif

  # Use passed headline_text only if metafield headline is not available
  if headline_text == blank and passed_headline_text != blank
    assign headline_text = passed_headline_text
  endif
%}

{% unless product != empty %}
  <!-- Error: product parameter required for product-card-mini snippet -->
  {% break %}
{% endunless %}

<div class="product-card-mini flex items-center gap-4 rounded-2xl [background:var(--product-background)] p-3 {{ card_class }}">
  <a
    href="{{ product.url }}"
    class="w-20 h-20 shrink-0 relative overflow-hidden rounded-xl"
  >
    {% if product.featured_media %}
      {% liquid
        assign media_alt = product.featured_media.alt | default: product.title
      %}
      {{
        product.featured_media
        | image_url: width: 512, height: 512, crop: 'center'
        | image_tag: class: 'product-card-mini__image w-full h-full object-cover', alt: media_alt, loading: 'lazy'
      }}
    {% else %}
      <div class="product-card-mini__placeholder" aria-hidden="true"></div>
    {% endif %}
  </a>

  <div class="flex flex-1 flex-col gap-1 text-left min-w-0">
    <h3 class="text-foreground">
      <a href="{{ product.url }}" class="transition hover:opacity-80">
        {{ product.title | escape }}
      </a>
    </h3>
    {% if headline_text != blank %}
      <p class="text-sm text-gray-600 truncate">
        {{ headline_text | truncate: 120 }}
      </p>
    {% endif %}
    {% liquid
      assign selected_variant = product.selected_or_first_available_variant
    %}
    {% if selected_variant %}
      <div class="text-sm font-medium text-foreground">
        {{ selected_variant.price | money }}
        {% if selected_variant.compare_at_price > selected_variant.price %}
          <span class="text-gray-500 line-through ml-1">{{ selected_variant.compare_at_price | money }}</span>
        {% endif %}
      </div>
    {% endif %}
  </div>

  {% comment %}
    <div class="shrink-0">
      {% render 'product-mini-buy-form',
        product: product,
        show_dynamic_checkout: show_dynamic_checkout,
        gift_card_recipient_feature_active: true,
        section_id: 'product-card-mini',
        product_form_id: 'product-card-mini-form',
        button_full_width: false,
        quantity_rule_soldout: false
      %}
    </div>
  {% endcomment %}
</div>

{% stylesheet %}
  .product-card-mini__image {
    transition: transform 0.3s ease;
  }

  .product-card-mini:hover .product-card-mini__image {
    transform: scale(1.03);
  }

  .product-card-mini__placeholder {
    width: 128px;
    height: 128px;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.04), rgba(0, 0, 0, 0.12));
  }
{% endstylesheet %}
