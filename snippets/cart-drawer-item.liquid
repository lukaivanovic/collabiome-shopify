{% doc %}
  Cart Drawer Item Component

  Renders a single cart item card with all details, quantity controls, and pricing.

  @param {object} item - Cart item object (required)

  @example
  {% render 'cart-drawer-item', item: item %}
{% enddoc %}

{% liquid
  assign item = item | default: empty

  unless item != empty
    echo '<!-- Error: item parameter required for cart-drawer-item snippet -->'
    break
  endunless

  assign has_qty_rules = false
  if item.variant.quantity_rule.increment > 1 or item.variant.quantity_rule.min > 1 or item.variant.quantity_rule.max != null
    assign has_qty_rules = true
  endif

  assign has_vol_pricing = false
  if item.variant.quantity_price_breaks.size > 0
    assign has_vol_pricing = true
  endif

  # Extract volume from variant options (e.g., "250 ml", "500 ml")
  assign volume = blank
  if item.product.has_only_default_variant == false
    for option in item.options_with_values
      if option.name == 'Volume' or option.name == 'Size' or option.value contains 'ml' or option.value contains 'ML'
        assign volume = option.value
        break
      endif
    endfor
  endif
%}

<div
  id="CartDrawer-Item-{{ item.index | plus: 1 }}"
  class="cart-item-card bg-white border-b border-neutral-200 last:border-b-0 relative{% if item.parent_relationship.parent != null %} cart-item__nested-line{% endif %}"
  {% if item.parent_relationship.parent != null %}
    aria-label="{{ item.product.title | escape }} part of {{ item.parent_relationship.parent.title | escape }}"
  {% endif %}
>
  <div class="flex items-center gap-4 relative">
    {%- comment -%} Product Image (Left) {%- endcomment -%}
    <div class="cart-item__media flex-shrink-0">
      {% if item.image %}
        <a href="{{ item.url }}" class="block">
          <img
            class="cart-item__image w-24 h-24 object-contain rounded-lg"
            src="{{ item.image | image_url: width: 300 }}"
            alt="{{ item.image.alt | escape }}"
            loading="lazy"
            width="96"
            height="96"
          >
        </a>
      {% endif %}
    </div>

    {%- comment -%} Product Details (Center-Left) {%- endcomment -%}
    <div class="flex-1 flex flex-col gap-1">
      <a href="{{ item.url }}" class="cart-item__name text-lg font-medium hover:underline">
        <p>{{- item.product.title | escape -}}</p>
      </a>
      {% if volume != blank %}
        <p class="text-sm text-neutral-500">{{ volume }}</p>
      {% endif %}

      {%- comment -%} Quantity Selector (Below Title) {%- endcomment -%}
      <div class="flex items-center gap-2 mt-2">
        <quantity-popover>
          <quantity-input class="quantity cart-quantity flex items-center gap-2">
            {%- comment -%} Minus Button {%- endcomment -%}
            <button
              class="quantity__button w-6 h-6 rounded-full bg-pink-50 border border-pink-800/30 flex items-center justify-center hover:bg-pink-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              name="minus"
              type="button"
              aria-label="Decrease quantity for {{ item.product.title | escape }}"
              {% if item.instructions and item.instructions.can_update_quantity == false %}
                disabled
              {% endif %}
            >
              <span class="svg-wrapper w-4 h-4 text-pink-900">
                {{- 'icon-minus.svg' | inline_asset_content -}}
              </span>
            </button>

            {%- comment -%} Quantity Display {%- endcomment -%}
            <div class="quantity__display w-6 h-6 rounded-full bg-pink-50 border border-pink-800/30 flex items-center justify-center">
              <input
                class="quantity__input w-6 h-6 text-center text-pink-900 font-medium bg-transparent border-none p-0 leading-none text-sm"
                type="number"
                data-quantity-variant-id="{{ item.variant.id }}"
                name="updates[]"
                value="{{ item.quantity }}"
                {% # theme-check-disable %}
                data-cart-quantity="{{ cart | item_count_for_variant: item.variant.id }}"
                min="0"
                data-min="{{ item.variant.quantity_rule.min }}"
                {% if item.variant.quantity_rule.max != null %}
                  max="{{ item.variant.quantity_rule.max }}"
                {% endif %}
                step="{{ item.variant.quantity_rule.increment }}"
                {% # theme-check-enable %}
                aria-label="Quantity for {{ item.product.title | escape }}"
                id="Drawer-quantity-{{ item.index | plus: 1 }}"
                data-index="{{ item.index | plus: 1 }}"
                {% if item.instructions and item.instructions.can_update_quantity == false %}
                  disabled
                {% endif %}
              >
            </div>

            {%- comment -%} Plus Button {%- endcomment -%}
            <button
              class="quantity__button w-6 h-6 rounded-full bg-pink-50 border border-pink-800/30 flex items-center justify-center hover:bg-pink-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              name="plus"
              type="button"
              aria-label="Increase quantity for {{ item.product.title | escape }}"
              {% if item.instructions and item.instructions.can_update_quantity == false %}
                disabled
              {% endif %}
            >
              <span class="svg-wrapper w-4 h-4 text-pink-900">
                {{- 'icon-plus.svg' | inline_asset_content -}}
              </span>
            </button>
          </quantity-input>

          {%- comment -%} Quantity Rules Popover {%- endcomment -%}
          {%- if has_vol_pricing or has_qty_rules -%}
            <button
              type="button"
              class="text-sm text-neutral-600 hover:text-neutral-900 flex items-center gap-1 ml-2"
              aria-expanded="false"
            >
              <span class="svg-wrapper w-4 h-4">
                {{- 'icon-info.svg' | inline_asset_content -}}
              </span>
            </button>

            <div
              class="cart-items__info global-settings-popup quantity-popover__info"
              tabindex="-1"
              hidden
            >
              {%- if has_qty_rules == false -%}
                <span class="volume-pricing-label caption">Volume pricing</span>
              {%- endif -%}
              <div class="quantity__rules caption">
                {%- if item.variant.quantity_rule.increment > 1 -%}
                  <span class="divider">
                    Must be purchased in multiples of {{ item.variant.quantity_rule.increment }}
                  </span>
                {%- endif -%}
                {%- if item.variant.quantity_rule.min > 1 -%}
                  <span class="divider"> Minimum of {{ item.variant.quantity_rule.min }} </span>
                {%- endif -%}
                {%- if item.variant.quantity_rule.max != null -%}
                  <span class="divider"> Maximum of {{ item.variant.quantity_rule.max }} </span>
                {%- endif -%}
              </div>
              <button
                class="button-close button button--tertiary"
                type="button"
                aria-label="Close"
              >
                <span class="svg-wrapper">
                  {{- 'icon-close.svg' | inline_asset_content -}}
                </span>
              </button>
              {%- if item.variant.quantity_price_breaks.size > 0 -%}
                <volume-pricing class="parent-display">
                  <ul class="list-unstyled">
                    <li>
                      <span>{{ item.variant.quantity_rule.min }}+</span>
                      <span>{{ item.variant.price | money_with_currency }}/ea</span>
                    </li>
                    {%- for price_break in item.variant.quantity_price_breaks -%}
                      <li>
                        <span>
                          {{- price_break.minimum_quantity -}}
                          <span aria-hidden="true">+</span></span
                        >
                        <span>{{ price_break.price | money_with_currency }}/ea</span>
                      </li>
                    {%- endfor -%}
                  </ul>
                </volume-pricing>
              {%- endif -%}
            </div>
          {%- endif -%}

          {%- comment -%} Error Message {%- endcomment -%}
          <div
            id="CartDrawer-LineItemError-{{ item.index | plus: 1 }}"
            class="cart-item__error"
            role="alert"
          >
            <small class="cart-item__error-text"></small>
            <span class="svg-wrapper">
              {{- 'icon-error.svg' | inline_asset_content -}}
            </span>
          </div>
        </quantity-popover>
      </div>
    </div>

    {%- comment -%} Action & Price (Right) {%- endcomment -%}
    <div class="flex flex-col items-end justify-end flex-shrink-0 self-end">
      {%- comment -%} Price {%- endcomment -%}
      <div class="text-right">
        {%- if item.original_line_price != item.final_line_price -%}
          <div class="flex flex-col gap-1">
            <span class="visually-hidden">Regular price</span>
            <s class="text-sm text-neutral-500">
              {{ item.original_line_price | money }}
            </s>
            <span class="visually-hidden">Sale price</span>
            <p>{{ item.final_line_price | money }}</p>
          </div>
        {%- else -%}
          <p>{{ item.original_line_price | money }}</p>
        {%- endif -%}
      </div>
    </div>

    {%- comment -%} Delete Button (Top Right) {%- endcomment -%}
    <cart-remove-button
      id="CartDrawer-Remove-{{ item.index | plus: 1 }}"
      data-index="{{ item.index | plus: 1 }}"
      class="absolute top-0 right-0"
    >
      <button
        type="button"
        class="text-neutral-500 hover:text-neutral-700 transition-colors flex items-center justify-center"
        aria-label="Remove {{ item.title | escape }}"
        data-variant-id="{{ item.variant.id }}"
        {% if item.instructions and item.instructions.can_remove == false %}
          class="hidden"
        {% endif %}
      >
        {{- 'icon-trash.svg' | inline_asset_content -}}
      </button>
    </cart-remove-button>
  </div>

  {%- comment -%} Discounts (if any) - Below main row {%- endcomment -%}
  {%- if item.line_level_discount_allocations.size > 0 -%}
    <div class="mt-2">
      <ul class="flex flex-col gap-1" role="list" aria-label="Discount">
        {%- for discount in item.line_level_discount_allocations -%}
          <li class="flex items-center gap-1 text-sm text-green-600">
            <span class="svg-wrapper w-4 h-4">
              {{- 'icon-discount.svg' | inline_asset_content -}}
            </span>
            {{ discount.discount_application.title }}
          </li>
        {%- endfor -%}
      </ul>
    </div>
  {%- endif -%}
</div>
