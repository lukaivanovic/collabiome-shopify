{% doc %}
  Cart Drawer Item Component

  Renders a single cart item card with all details, quantity controls, and pricing.

  @param {object} item - Cart item object (required)

  @example
  {% render 'cart-drawer-item', item: item %}
{% enddoc %}

{% liquid
  assign item = item | default: empty

  unless item != empty
    echo '<!-- Error: item parameter required for cart-drawer-item snippet -->'
    break
  endunless

  assign has_qty_rules = false
  if item.variant.quantity_rule.increment > 1 or item.variant.quantity_rule.min > 1 or item.variant.quantity_rule.max != null
    assign has_qty_rules = true
  endif

  assign has_vol_pricing = false
  if item.variant.quantity_price_breaks.size > 0
    assign has_vol_pricing = true
  endif

  # Extract volume from variant options (e.g., "250 ml", "500 ml")
  assign volume = blank
  if item.product.has_only_default_variant == false
    for option in item.options_with_values
      if option.name == 'Volume' or option.name == 'Size' or option.value contains 'ml' or option.value contains 'ML'
        assign volume = option.value
        break
      endif
    endfor
  endif
%}

<div
  id="CartDrawer-Item-{{ item.index | plus: 1 }}"
  class=" bg-white border-b px-4 flex items-center gap-4 border-neutral-200 py-4 last:border-b-0 relative{% if item.parent_relationship.parent != null %} cart-item__nested-line{% endif %}"
  {% if item.parent_relationship.parent != null %}
    aria-label="{{ item.product.title | escape }} dio paketa {{ item.parent_relationship.parent.title | escape }}"
  {% endif %}
>
  <div class="loading__spinner hidden absolute bottom-6 right-6 size-4 ">
    {{ 'loading-spinner.svg' | inline_asset_content }}
  </div>

  {%- comment -%} Product Image (Left) {%- endcomment -%}
  <div class="cart-item__media flex-shrink-0">
    {% if item.image %}
      <a href="{{ item.url }}" class="block">
        <img
          class="cart-item__image w-26 h-26 object-contain rounded-lg"
          src="{{ item.image | image_url: width: 300 }}"
          alt="{{ item.image.alt | escape }}"
          loading="lazy"
          width="104"
          height="104"
        >
      </a>
    {% endif %}
  </div>

  {%- comment -%} Product Details (Center-Left) {%- endcomment -%}
  <div class="flex-1 flex flex-col">
    <a href="{{ item.url }}" class="font-medium">
      <p>{{- item.product.title | escape -}}</p>
    </a>
    {% if volume != blank %}
      <p class="text-sm text-neutral-500">{{ volume }}</p>
    {% endif %}
    <div>
      {%- if item.original_line_price != item.final_line_price -%}
        <div class="flex flex-col">
          <span class="visually-hidden">Redovna cijena</span>
          <span class="text-xs text-neutral-500">
            {{ item.original_line_price | money }}
          </span>
          <span class="visually-hidden">Snižena cijena</span>
          <p class="text-xs text-neutral-900">{{ item.final_line_price | money }}</p>
        </div>
      {%- else -%}
        <p class="text-sm text-neutral-900 font-medium">{{ item.original_line_price | money }}</p>
      {%- endif -%}
    </div>

    {%- comment -%} Quantity Selector (Below Title) {%- endcomment -%}
    <div class="flex items-center gap-2 mt-2">
      <quantity-popover>
        <quantity-input class="quantity cart-quantity flex items-center gap-0.5 border-neutral-100 border rounded-sm p-0.5">
          {%- comment -%} Minus Button {%- endcomment -%}
          <button
            class="quantity__button w-5 h-5 rounded-sm bg-neutral-200  flex items-center justify-center hover:bg-neutral-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            name="minus"
            type="button"
            aria-label="Smanji količinu za {{ item.product.title | escape }}"
            {% if item.instructions and item.instructions.can_update_quantity == false %}
              disabled
            {% endif %}
          >
            <span class="svg-wrapper w-4 h-4 text-pink-900">
              {{- 'icon-minus.svg' | inline_asset_content -}}
            </span>
          </button>

          {%- comment -%} Quantity Display {%- endcomment -%}
          <div class="quantity__display w-6 h-6  flex items-center justify-center">
            <input
              class="quantity__input w-6 h-6 text-center text-neutral-900 font-medium bg-transparent border-none p-0 leading-none text-xs!"
              type="number"
              data-quantity-variant-id="{{ item.variant.id }}"
              name="updates[]"
              value="{{ item.quantity }}"
              {% # theme-check-disable %}
              data-cart-quantity="{{ cart | item_count_for_variant: item.variant.id }}"
              min="0"
              data-min="{{ item.variant.quantity_rule.min }}"
              {% if item.variant.quantity_rule.max != null %}
                max="{{ item.variant.quantity_rule.max }}"
              {% endif %}
              step="{{ item.variant.quantity_rule.increment }}"
              {% # theme-check-enable %}
              aria-label="Količina za {{ item.product.title | escape }}"
              id="Drawer-quantity-{{ item.index | plus: 1 }}"
              data-index="{{ item.index | plus: 1 }}"
              {% if item.instructions and item.instructions.can_update_quantity == false %}
                disabled
              {% endif %}
            >
          </div>

          {%- comment -%} Plus Button {%- endcomment -%}
          <button
            class="quantity__button w-5 h-5 rounded-sm bg-neutral-200  flex items-center justify-center hover:bg-neutral-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            name="plus"
            type="button"
            aria-label="Povećaj količinu za {{ item.product.title | escape }}"
            {% if item.instructions and item.instructions.can_update_quantity == false %}
              disabled
            {% endif %}
          >
            <span class="svg-wrapper [&>svg]:w-3 [&>svg]:h-3 text-neutral-600">
              {{- 'icon-plus.svg' | inline_asset_content -}}
            </span>
          </button>
        </quantity-input>

        {%- comment -%} Quantity Rules Popover {%- endcomment -%}
        {%- if has_vol_pricing or has_qty_rules -%}
          <button
            type="button"
            class="text-sm text-neutral-600 hover:text-neutral-900 flex items-center gap-1 ml-2"
            aria-expanded="false"
          >
            <span class="svg-wrapper w-4 h-4">
              {{- 'icon-info.svg' | inline_asset_content -}}
            </span>
          </button>

          <div
            class="cart-items__info global-settings-popup quantity-popover__info"
            tabindex="-1"
            hidden
          >
            {%- if has_qty_rules == false -%}
              <span class="volume-pricing-label caption">Količinski popust</span>
            {%- endif -%}
            <div class="quantity__rules caption">
              {%- if item.variant.quantity_rule.increment > 1 -%}
                <span class="divider">
                  Mora se kupiti u višekratnicima od {{ item.variant.quantity_rule.increment }}
                </span>
              {%- endif -%}
              {%- if item.variant.quantity_rule.min > 1 -%}
                <span class="divider"> Najmanje {{ item.variant.quantity_rule.min }} </span>
              {%- endif -%}
              {%- if item.variant.quantity_rule.max != null -%}
                <span class="divider"> Najviše {{ item.variant.quantity_rule.max }} </span>
              {%- endif -%}
            </div>
            <button
              class="button-close button button--tertiary"
              type="button"
              aria-label="Zatvori"
            >
              <span class="svg-wrapper">
                {{- 'icon-close.svg' | inline_asset_content -}}
              </span>
            </button>
            {%- if item.variant.quantity_price_breaks.size > 0 -%}
              <volume-pricing class="parent-display">
                <ul class="list-unstyled">
                  <li>
                    <span>{{ item.variant.quantity_rule.min }}+</span>
                    <span>{{ item.variant.price | money_with_currency }}/ea</span>
                  </li>
                  {%- for price_break in item.variant.quantity_price_breaks -%}
                    <li>
                      <span>
                        {{- price_break.minimum_quantity -}}
                        <span aria-hidden="true">+</span></span
                      >
                      <span>{{ price_break.price | money_with_currency }}/ea</span>
                    </li>
                  {%- endfor -%}
                </ul>
              </volume-pricing>
            {%- endif -%}
          </div>
        {%- endif -%}

        {%- comment -%} Error Message {%- endcomment -%}
        <div
          id="CartDrawer-LineItemError-{{ item.index | plus: 1 }}"
          class="cart-item__error"
          role="alert"
        >
          <small class="cart-item__error-text"></small>
          <span class="svg-wrapper">
            {{- 'icon-error.svg' | inline_asset_content -}}
          </span>
        </div>
      </quantity-popover>

      <cart-remove-button
        id="CartDrawer-Remove-{{ item.index | plus: 1 }}"
        data-index="{{ item.index | plus: 1 }}"
      >
        <button
          type="button"
          class="text-neutral-500 hover:text-neutral-700 transition-colors flex items-center justify-center"
          aria-label="Ukloni {{ item.title | escape }}"
          data-variant-id="{{ item.variant.id }}"
          {% if item.instructions and item.instructions.can_remove == false %}
            class="hidden"
          {% endif %}
        >
          {{- 'icon-trash.svg' | inline_asset_content -}}
        </button>
      </cart-remove-button>
    </div>
  </div>

  {%- comment -%} Delete Button (Top Right) {%- endcomment -%}
</div>

{%- comment -%} Discounts (if any) - Below main row {%- endcomment -%}
{% comment %}
  {%- if item.line_level_discount_allocations.size > 0 -%}
    <div class="mt-2">
      <ul class="flex flex-col gap-1" role="list" aria-label="Popust">
        {%- for discount in item.line_level_discount_allocations -%}
          <li class="flex items-center gap-1 text-sm text-green-600">
            <span class="svg-wrapper w-4 h-4">
              {{- 'icon-discount.svg' | inline_asset_content -}}
            </span>
            {{ discount.discount_application.title }}
          </li>
        {%- endfor -%}
      </ul>
    </div>
  {%- endif -%}
{% endcomment %}
