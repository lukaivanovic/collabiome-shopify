{% doc %}
  Product Variant Selector (Select)

  Renders product variant options as native HTML select dropdowns.

  @param {product} product - Product object (required)
{% enddoc %}

{% liquid
  if product == blank
    echo '<!-- Error: product required for product-variant-selector-select -->'
    break
  endif
%}

{% unless product.has_only_default_variant %}
  <div class="flex flex-col gap-4">
    {% for option in product.options_with_values %}
      <div class="w-full flex items-center justify-start gap-2 border-t border-neutral-100 pt-2">
        <select
          id="product-options-select-{{ option.position }}"
          name="options[{{ option.name }}]"
          class="ml-px py-1 rounded-md text-sm! bg-white text-primary font-medium! focus:outline-none"
          data-option-input
          data-option-position="{{ option.position }}"
        >
          {% for value in option.values %}
            {% liquid
              # Find variant that matches this option value
              # Prefer variant with discount, otherwise use first matching variant
              assign matching_variant = null
              assign discount_variant = null
              assign discount_text = ''
              assign option_index = option.position | minus: 1

              for variant in product.variants
                if variant.options[option_index] == value
                  if matching_variant == null
                    assign matching_variant = variant
                  endif

                  # Track variant with discount
                  if variant.compare_at_price > variant.price
                    if discount_variant == null
                      assign discount_variant = variant
                    endif
                  endif
                endif
              endfor

              # Use discount variant if found, otherwise use first matching variant
              if discount_variant != null
                assign matching_variant = discount_variant
              endif

              # Calculate discount percentage if variant has compare_at_price
              if matching_variant != null and matching_variant.compare_at_price > matching_variant.price
                assign compare_at_price = matching_variant.compare_at_price
                assign current_price = matching_variant.price
                assign savings = compare_at_price | minus: current_price
                assign savings_times_100 = savings | times: 100
                assign savings_percent = savings_times_100 | divided_by: compare_at_price | round
                assign discount_text = ' (-' | append: savings_percent | append: '%)'
              endif
            %}
            <option
              value="{{ value }}"
              {% if option.selected_value == value %}
                selected
              {% endif %}
            >
              {{ value -}}
              {{- discount_text }}
            </option>
          {% endfor %}
        </select>
        <span
          class="hidden text-xs font-medium px-1.5 py-0.5 tabular-nums rounded-full bg-[var(--product-accent)] text-[var(--product-button-text-color)] whitespace-nowrap"
          data-variant-badge
          data-option-position="{{ option.position }}"
        ></span>
      </div>
    {% endfor %}
  </div>
{% endunless %}
